{
	"name": "SCD CLIENTE",
	"properties": {
		"folder": {
			"name": "DATA CLEANSING"
		},
		"content": {
			"query": "TRUNCATE TABLE  temp.clientes_processamento\nTRUNCATE TABLE  temp.clientes_final\n\ninsert into temp.clientes_processamento\nselect   \nconcat(ESTAB_IDCIGAM, CONVERT(INT,CLIENTE_CODIGO)) as PK_CLIENTE\n,[ESTAB_IDCIGAM]\n,[CLIENTE_CODIGO]\n,[CLIENTE_NOME]\n,[CLIENTE_CPFCNPJ]\n,[CLIENTE_EMAIL]\n,[CLIENTE_CIDADE]\n,[CLIENTE_ESTADO]\n,[CLIENTE_SEXO]\n,[CLIENTE_ANIVERSARIO]\n,[CLIENTE_DDD_CELULAR]\n,[CLIENTE_CELULAR]\n,[CLIENTE_ENDERECO]\n,[CLIENTE_NUMERO]\n,[CLIENTE_COMPLEMENTO]\n,[CLIENTE_BAIRRO]\n,[CLIENTE_CEP]\n,[NUM_MATRICULA]\n,'SEM ALTERACAO' AS TIPO_ACAO\n,FLAG_VIGENCIA\n,DAT_INICIO_VIGENCIA\n,DAT_FINAL_VIGENCIA \nfrom [cleansing_data].[gst_bi_clientes]\n\ninsert into temp.clientes_final\nselect    \n PK_CLIENTE\n,[ESTAB_IDCIGAM]\n,[CLIENTE_CODIGO]\n,[CLIENTE_NOME]\n,[CLIENTE_CPFCNPJ]\n,[CLIENTE_EMAIL]\n,[CLIENTE_CIDADE]\n,[CLIENTE_ESTADO]\n,[CLIENTE_SEXO]\n,[CLIENTE_ANIVERSARIO]\n,[CLIENTE_DDD_CELULAR]\n,[CLIENTE_CELULAR]\n,[CLIENTE_ENDERECO]\n,[CLIENTE_NUMERO]\n,[CLIENTE_COMPLEMENTO]\n,[CLIENTE_BAIRRO]\n,[CLIENTE_CEP]\n,[NUM_MATRICULA]\n,FLAG_VIGENCIA\n,DAT_INICIO_VIGENCIA\n,DAT_FINAL_VIGENCIA \nfrom temp.clientes_processamento\n\nMERGE  temp.clientes_processamento AS CLIENTE \nUSING(\n\t    select   \n         concat(ESTAB_IDCIGAM, CONVERT(INT,CLIENTE_CODIGO)) as PK_CLIENTE\n        ,[ESTAB_IDCIGAM]\n        ,[CLIENTE_CODIGO]\n        ,[CLIENTE_NOME]\n        ,[CLIENTE_CPFCNPJ]\n        ,[CLIENTE_EMAIL]\n        ,[CLIENTE_CIDADE]\n        ,[CLIENTE_ESTADO]\n        ,[CLIENTE_SEXO]\n        ,[CLIENTE_ANIVERSARIO]\n        ,[CLIENTE_DDD_CELULAR]\n        ,[CLIENTE_CELULAR]\n        ,[CLIENTE_ENDERECO]\n        ,[CLIENTE_NUMERO]\n        ,[CLIENTE_COMPLEMENTO]\n        ,[CLIENTE_BAIRRO]\n        ,[CLIENTE_CEP]\n        ,[NUM_MATRICULA]\n        ,1 as FLAG_VIGENCIA \n        ,getdate() as DAT_INICIO_VIGENCIA\n        ,null DAT_FINAL_VIGENCIA \n        from [raw_data].[cigam_gst_bi_cliente]\n        WHERE DAT_HORA_EXPORTACAO = '2021-02-23 14:15'\n) AS DL ON (DL.PK_CLIENTE = CLIENTE.PK_CLIENTE)\n\tWHEN NOT MATCHED BY TARGET THEN INSERT (\n                                                    PK_CLIENTE\n                                                    ,ESTAB_IDCIGAM\n                                                    ,CLIENTE_CODIGO\n                                                    ,CLIENTE_NOME\n                                                    ,CLIENTE_CPFCNPJ\n                                                    ,CLIENTE_EMAIL\n                                                    ,CLIENTE_CIDADE\n                                                    ,CLIENTE_ESTADO\n                                                    ,CLIENTE_SEXO\n                                                    ,CLIENTE_ANIVERSARIO\n                                                    ,CLIENTE_DDD_CELULAR\n                                                    ,CLIENTE_CELULAR\n                                                    ,CLIENTE_ENDERECO\n                                                    ,CLIENTE_NUMERO\n                                                    ,CLIENTE_COMPLEMENTO\n                                                    ,CLIENTE_BAIRRO\n                                                    ,CLIENTE_CEP\n                                                    ,NUM_MATRICULA\n                                                    ,TIPO_ACAO\n                                                    ,FLAG_VIGENCIA\n                                                    ,DAT_INICIO_VIGENCIA\n                                                    ,DAT_FINAL_VIGENCIA\n                                               )\n\t\t\t\t\t\t\t\t\tVALUES (DL.PK_CLIENTE\n                                            ,DL.ESTAB_IDCIGAM\n                                            ,DL.CLIENTE_CODIGO\n                                            ,DL.CLIENTE_NOME\n                                            ,DL.CLIENTE_CPFCNPJ\n                                            ,DL.CLIENTE_EMAIL\n                                            ,DL.CLIENTE_CIDADE\n                                            ,DL.CLIENTE_ESTADO\n                                            ,DL.CLIENTE_SEXO\n                                            ,DL.CLIENTE_ANIVERSARIO\n                                            ,DL.CLIENTE_DDD_CELULAR\n                                            ,DL.CLIENTE_CELULAR\n                                            ,DL.CLIENTE_ENDERECO\n                                            ,DL.CLIENTE_NUMERO\n                                            ,DL.CLIENTE_COMPLEMENTO\n                                            ,DL.CLIENTE_BAIRRO\n                                            ,DL.CLIENTE_CEP\n                                            ,DL.NUM_MATRICULA\n                                            ,'INSERT'\n                                            ,DL.FLAG_VIGENCIA\n                                            ,DL.DAT_INICIO_VIGENCIA\n                                            ,DL.DAT_FINAL_VIGENCIA)\n    WHEN MATCHED AND (  CLIENTE.CLIENTE_NOME != DL.CLIENTE_NOME OR\n                        CLIENTE.CLIENTE_CPFCNPJ  != DL.CLIENTE_CPFCNPJ OR\n                        CLIENTE.CLIENTE_EMAIL  != DL.CLIENTE_EMAIL OR\n                        CLIENTE.CLIENTE_CIDADE  != DL.CLIENTE_CIDADE OR\n                        CLIENTE.CLIENTE_ESTADO  != DL.CLIENTE_ESTADO OR\n                        CLIENTE.CLIENTE_SEXO  != DL.CLIENTE_SEXO OR\n                        CLIENTE.CLIENTE_ANIVERSARIO  != DL.CLIENTE_ANIVERSARIO OR\n                        CLIENTE.CLIENTE_DDD_CELULAR  != DL.CLIENTE_DDD_CELULAR OR\n                        CLIENTE.CLIENTE_CELULAR  != DL.CLIENTE_CELULAR OR\n                        CLIENTE.CLIENTE_ENDERECO  != DL.CLIENTE_ENDERECO OR\n                        CLIENTE.CLIENTE_NUMERO  != DL.CLIENTE_NUMERO OR\n                        CLIENTE.CLIENTE_COMPLEMENTO  != DL.CLIENTE_COMPLEMENTO OR\n                        CLIENTE.CLIENTE_BAIRRO  != DL.CLIENTE_BAIRRO OR\n                        CLIENTE.CLIENTE_CEP  != DL.CLIENTE_CEP OR\n                        CLIENTE.NUM_MATRICULA  != DL.NUM_MATRICULA )\n    THEN UPDATE SET \n                    CLIENTE.CLIENTE_NOME = DL.CLIENTE_NOME \n                    ,CLIENTE.CLIENTE_CPFCNPJ  = DL.CLIENTE_CPFCNPJ\n                    ,CLIENTE.CLIENTE_EMAIL  = DL.CLIENTE_EMAIL\n                    ,CLIENTE.CLIENTE_CIDADE  = DL.CLIENTE_CIDADE\n                    ,CLIENTE.CLIENTE_ESTADO  = DL.CLIENTE_ESTADO\n                    ,CLIENTE.CLIENTE_SEXO  = DL.CLIENTE_SEXO\n                    ,CLIENTE.CLIENTE_ANIVERSARIO  = DL.CLIENTE_ANIVERSARIO\n                    ,CLIENTE.CLIENTE_DDD_CELULAR  = DL.CLIENTE_DDD_CELULAR\n                    ,CLIENTE.CLIENTE_CELULAR  = DL.CLIENTE_CELULAR\n                    ,CLIENTE.CLIENTE_ENDERECO  = DL.CLIENTE_ENDERECO\n                    ,CLIENTE.CLIENTE_NUMERO  = DL.CLIENTE_NUMERO\n                    ,CLIENTE.CLIENTE_COMPLEMENTO  = DL.CLIENTE_COMPLEMENTO\n                    ,CLIENTE.CLIENTE_BAIRRO  = DL.CLIENTE_BAIRRO\n                    ,CLIENTE.CLIENTE_CEP  = DL.CLIENTE_CEP\n                    ,CLIENTE.NUM_MATRICULA  = DL.NUM_MATRICULA\n                    ,TIPO_ACAO = 'UPDATE'\n                    ,CLIENTE.FLAG_VIGENCIA  =1\n                    ,CLIENTE.DAT_INICIO_VIGENCIA  =GETDATE()\n                    ,CLIENTE.DAT_FINAL_VIGENCIA  = NULL;\n\ninsert into  temp.clientes_final  \nselect \n PK_CLIENTE\n,[ESTAB_IDCIGAM]\n,[CLIENTE_CODIGO]\n,[CLIENTE_NOME]\n,[CLIENTE_CPFCNPJ]\n,[CLIENTE_EMAIL]\n,[CLIENTE_CIDADE]\n,[CLIENTE_ESTADO]\n,[CLIENTE_SEXO]\n,[CLIENTE_ANIVERSARIO]\n,[CLIENTE_DDD_CELULAR]\n,[CLIENTE_CELULAR]\n,[CLIENTE_ENDERECO]\n,[CLIENTE_NUMERO]\n,[CLIENTE_COMPLEMENTO]\n,[CLIENTE_BAIRRO]\n,[CLIENTE_CEP]\n,[NUM_MATRICULA]\n,FLAG_VIGENCIA \n,DAT_INICIO_VIGENCIA\n,DAT_FINAL_VIGENCIA  from temp.clientes_processamento where \n tipo_acao = 'insert'\n\nupdate temp.clientes_final   \nset \nflag_vigencia = 0, \ndat_final_vigencia = getdate()\nwhere PK_CLIENTE in (select  PK_CLIENTE  from temp.clientes_processamento where  tipo_acao = 'update')\nand flag_vigencia = 1\n\ninsert into  temp.clientes_final  \nselect \n PK_CLIENTE\n,[ESTAB_IDCIGAM]\n,[CLIENTE_CODIGO]\n,[CLIENTE_NOME]\n,[CLIENTE_CPFCNPJ]\n,[CLIENTE_EMAIL]\n,[CLIENTE_CIDADE]\n,[CLIENTE_ESTADO]\n,[CLIENTE_SEXO]\n,[CLIENTE_ANIVERSARIO]\n,[CLIENTE_DDD_CELULAR]\n,[CLIENTE_CELULAR]\n,[CLIENTE_ENDERECO]\n,[CLIENTE_NUMERO]\n,[CLIENTE_COMPLEMENTO]\n,[CLIENTE_BAIRRO]\n,[CLIENTE_CEP]\n,[NUM_MATRICULA]\n,FLAG_VIGENCIA \n,DAT_INICIO_VIGENCIA\n,DAT_FINAL_VIGENCIA  from temp.clientes_processamento where \n tipo_acao = 'UPDATE'\n\n\n\n        \n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"poolName": "dwmwe",
				"databaseName": "dwmwe"
			}
		},
		"type": "SqlQuery"
	}
}