{
	"name": "sap fato ordem venda",
	"properties": {
		"folder": {
			"name": "MODELO DIMENSIONAL/sap"
		},
		"content": {
			"query": "--select sum(convert(numeric(18,2),NETWR)) as NETWR,\n--sum(convert(numeric(18,2),KWMENG)) as KWMENG\n--from cleansing_data.sap_vbap where VBELN = '0001289876'\n\n--select sum(convert(numeric(18,2),KWERT)) as KWERT,\n--sum(convert(numeric(18,2),KAWRT))  as KAWRT\n--from cleansing_data.sap_konv\n--where KSTAT is null  and KSCHL in('ZCMI','ICMI','ZNFC')\n--and  VBELN = '0001289876'\n\n\n;with vbak_vbap_cte as\n(\nselect \nconcat(vbak.KNUMV,vbap.POSNR) as pk_vbak_vbap\n,ztsd007.NUMPER\n,ztsd007.ANOPER\n,concat(ztsd007.ANOPER,'/',ztsd007.NUMPER) as ANO_PERIODO\n,vbap.VBELN\t\n,vbap.POSNR\t  \n,vbap.MATNR\t\n,vbap.PSTYV\t\n \n,vbap.KWMENG\t\n,vbak.ERDAT\t\n,vbak.ERNAM\t\n,vbak.AUDAT\t\n,vbak.VBTYP\t\n--,vbak.AUART\t\n,vbak.VKORG\t\n--,vbak.VTWEG\t\n,vbak.SPART\t\n,vbak.VKGRP\t\n,vbak.VKBUR\t\n,vbak.KNUMV\t\n,vbak.VDATU\t\n,vbak.BSARK\t --  = '0006' then 'VOA' \telse 'OUTROS'\n,vbak.KUNNR\t\n,vbak.AEDAT\t\n,vbak.KVGR3\t\n,vbak.BUKRS_VF\n,tvakt.AUART\n,tvakt.BEZEI + ' (' + tvakt.AUART + ')' as [BEZEI AUART OrdemVenda - Tp.Documento]\n,tvtwt.VTWEG --  '90' then 'Sim' \telse 'Não'\n,tvtwt.VTEXT\n,vbap.J_3ASEAN\n,vbap.[_-AFS_-COLLECTION]\n,vbap.WERKS\n,vbap.VRKME\n,vbap.NETWR\n\n,vbap.UMZIZ\n,vbap.UMZIN\n\n \n\nfrom cleansing_data.sap_vbap as vbap   \nleft join cleansing_data.sap_vbak as vbak on vbap.VBELN = vbak.VBELN\nleft join  cleansing_data.sap_ztsd007 as ztsd007 on \n\t\t   concat(ztsd007.VKORG,ztsd007.CODPER) = concat(vbak.VKORG, vbak.KVGR3)   \nleft join [cleansing_data].[sap_tvakt] as tvakt on tvakt.AUART = vbak.AUART\nleft join [cleansing_data].[sap_tvtwt] as tvtwt on tvtwt.VTWEG = vbak.VTWEG\n\n \n\n) \n,konv_cte \nas\n(\n \tselect \n\tconcat(KNUMV,KPOSN) as pk_konv_cte\n\t,KNUMV\t\n\t,KPOSN\t\n\t,STUNR\t\n\t,ZAEHK\t\n\t,KSCHL\t\n\t,KWERT\t\n\t,KAWRT\t\n\t,KBETR\t\n\t,KSTAT\t\n\t,KDATU\t\n\t,VBELN\t\n\tfrom cleansing_data.sap_konv\n\twhere KSTAT is null  and KSCHL in('ZCMI','ICMI','ZNFC')\n\t\n)\n\nselect \n\nvbak_vbap_cte.VBELN\n,vbak_vbap_cte.MATNR\n,vbak_vbap_cte.POSNR\n,vbak_vbap_cte.VBELN + '-' + vbak_vbap_cte.POSNR as VBELN_POSNR\n,vbak_vbap_cte.MATNR\n,vbak_vbap_cte.MATNR AS [Produto - Código]\n,vbak_vbap_cte.AUDAT\t\n,vbak_vbap_cte.VDATU\t\n,vbak_vbap_cte.MATNR\n,vbak_vbap_cte.J_3ASEAN\n,vbak_vbap_cte.[_-AFS_-COLLECTION]\n,vbak_vbap_cte.WERKS\n,vbak_vbap_cte.VRKME\n,vbak_vbap_cte.KWMENG\n,vbak_vbap_cte.NETWR\n,vbak_vbap_cte.PSTYV\n,vbak_vbap_cte.UMZIZ\n,vbak_vbap_cte.UMZIN\n\n\n\n--,CODIGO_CLIENTE\n--,CODLIGO_PRODUTO \n\n,vbak_vbap_cte.NUMPER\n,vbak_vbap_cte.ANOPER\n,vbak_vbap_cte.ANO_PERIODO\n,vbak_vbap_cte.AUART\n,vbak_vbap_cte.[BEZEI AUART OrdemVenda - Tp.Documento]\n,vbak_vbap_cte.VTEXT\n\n,sum(convert(numeric(18,2),vbak_vbap_cte.NETWR)) as QUANTIDADE_PECAS\n,sum(convert(numeric(18,2),vbak_vbap_cte.KWMENG)) as QUANTIDADE_PECAS_ITEM\n,sum(convert(numeric(18,2),konv_cte.KWERT)) as VALOR_ITEM\n,sum(convert(numeric(18,2),konv_cte.KAWRT)) as VALOR_BASE_CONDICAO\nfrom vbak_vbap_cte inner join konv_cte on \nvbak_vbap_cte.pk_vbak_vbap = konv_cte.pk_konv_cte\ngroup by \n\nvbak_vbap_cte.VBELN\n,vbak_vbap_cte.MATNR\n,vbak_vbap_cte.POSNR\n,vbak_vbap_cte.VBELN + '-' + vbak_vbap_cte.POSNR  \n,vbak_vbap_cte.MATNR\n,vbak_vbap_cte.MATNR  \n,vbak_vbap_cte.AUDAT\t\n,vbak_vbap_cte.VDATU\t\n,vbak_vbap_cte.MATNR\n,vbak_vbap_cte.J_3ASEAN\n,vbak_vbap_cte.[_-AFS_-COLLECTION]\n,vbak_vbap_cte.WERKS\n,vbak_vbap_cte.VRKME\n,vbak_vbap_cte.KWMENG\n,vbak_vbap_cte.NETWR\n,vbak_vbap_cte.PSTYV\n,vbak_vbap_cte.UMZIZ\n,vbak_vbap_cte.UMZIN\n\n\n\n--,CODIGO_CLIENTE\n--,CODLIGO_PRODUTO \n\n,vbak_vbap_cte.NUMPER\n,vbak_vbap_cte.ANOPER\n,vbak_vbap_cte.ANO_PERIODO\n,vbak_vbap_cte.AUART\n,vbak_vbap_cte.[BEZEI AUART OrdemVenda - Tp.Documento]\n,vbak_vbap_cte.VTEXT",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"poolName": "Built-in",
				"databaseName": "master"
			}
		},
		"type": "SqlQuery"
	}
}