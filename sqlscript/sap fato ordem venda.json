{
	"name": "sap fato ordem venda",
	"properties": {
		"folder": {
			"name": "MODELO DIMENSIONAL/sap"
		},
		"content": {
			"query": "--select sum(convert(numeric(18,2),NETWR)) as NETWR,\n--sum(convert(numeric(18,2),KWMENG)) as KWMENG\n--from cleansing_data.sap_vbap where VBELN = '0001289876'\n\n--select sum(convert(numeric(18,2),KWERT)) as KWERT,\n--sum(convert(numeric(18,2),KAWRT))  as KAWRT\n--from cleansing_data.sap_konv\n--where KSTAT is null  and KSCHL in('ZCMI','ICMI','ZNFC')\n--and  VBELN = '0001289876'\n\n\n;with vbak_vbap_cte as\n(\nselect \nconcat(vbak.KNUMV,vbap.POSNR) as pk_vbak_vbap\n,ztsd007.NUMPER           NUMERO_PERIODO_OV            \n,ztsd007.ANOPER           ANO_PERIODO_OV\n,concat(ztsd007.ANOPER,'/',ztsd007.NUMPER) as ANO_NUMERO_PERIODO_OV\n,vbap.VBELN\t             NUMERO_OV   \n,vbap.POSNR\t             NUMERO_ITEM_OV\n,vbap.MATNR\t             CODIGO_PRODUTO\n,vbap.PSTYV\t             CATEGORIA_ITEM_OV \n \n,vbap.KWMENG\t       QTDE_ITEM_OV\n,vbak.KUNNR            CODIGO_CLIENTE\n,vbak.ERDAT\t           DATA_CRIACAO_OV\n,vbak.ERNAM\t           CRIADO_POR_OV\n,vbak.AUDAT\t           DATA_DOCUMENTO_OV\n,vbak.VBTYP\t           CATEGORIA_DOCUMENTO_OV\n--,vbak.AUART\t\n,vbak.VKORG\t           ORGANIZACAO_VENDAS_OV\n--,vbak.VTWEG\t\n,vbak.SPART\t           SETOR_ATIVIDADE_OV\n,vbak.VKGRP\t           EQUIPE_VENDAS_OV\n,vbak.VKBUR\t           ESCRITORIO_VENDAS_OV\n,vbak.KNUMV\t           CODIGO_CONDICAO_DOCUMENTO_OV\n,vbak.VDATU\t           DATA_REMESSA_OV\n,vbak.BSARK\t TIPO_PEDIDO_OV --  = '0006' then 'VOA' \telse 'OUTROS'    TIPO_PEDIDO_OV\n,vbak.AEDAT\t           DATA_MODIFICACAO_OV\n,vbak.KVGR3\t           CODIGO_PERIODO_VENDAS_OV\n,vbak.BUKRS_VF         CODIGO_EMPRESA_OV\n,tvakt.AUART           CODIGO_TIPO_DOCUMENTO_VENDAS\n--,tvakt.BEZEI + ' (' + tvakt.AUART + ')' as BEZEI AUART OrdemVenda - Tp.Documento\n,tvtwt.VTWEG --  '90' then 'Sim' \telse 'NÃ£o'\n,tvtwt.VTEXT\n,vbap.J_3ASEAN\n--,vbap._-AFS_-COLLECTION\n,vbap.WERKS          CODIGO_CENTRO_OV_ITEM \n,vbap.VRKME          DESCRICAO_UNID_VENDA_OV_ITEM\n,vbap.NETWR          VALOR_LIQUIDO_OV_ITEM\n\n,vbap.UMZIZ          NUMERADOR_OV_ITEM\n,vbap.UMZIN          DENOMINADOR_OV_ITEM \n\n \n\nfrom cleansing_data.sap_vbap as vbap   \nleft join cleansing_data.sap_vbak as vbak on vbap.VBELN = vbak.VBELN\nleft join  cleansing_data.sap_ztsd007 as ztsd007 on \n\t\t   concat(ztsd007.VKORG,ztsd007.CODPER) = concat(vbak.VKORG, vbak.KVGR3)   \nleft join cleansing_data.sap_tvakt as tvakt on tvakt.AUART = vbak.AUART\nleft join cleansing_data.sap_tvtwt as tvtwt on tvtwt.VTWEG = vbak.VTWEG\n\n \n\n) \n,konv_cte \nas\n(\n \tselect \n\tconcat(KNUMV,KPOSN) as pk_konv_cte\n\t,KNUMV\tCODIGO_CONDICAO\n\t,KPOSN\tNUMERO_ITEM_CONDICAO\n\t,STUNR\tNUMERO_NIVEL_CONDICAO\n\t,ZAEHK\tCONTADOR_CONDICAO\n\t,KSCHL\tDESCRICAO_TIPO_CONDICAO\n\t,KWERT\tVALOR_CONDICAO\n\t,KAWRT\tVALOR_BASE_CONDICAO\n\t,KBETR\tVALOR_MONTANTE_CONDICAO\n\t,KSTAT\tESTATISTICA_CONDICAO\n\t,KDATU\tDATA_FIXA_PRECO_CONDICAO\n\t,VBELN\tNUMERO_OV\n\tfrom cleansing_data.sap_konv\n\twhere KSTAT !='X'  and KSCHL in('ZCMI','ICMI','ZNFC')\n\n\t\n\t\n)\n\nSELECT \nvbak_vbap_cte.PK_VBAK_VBAP\n,vbak_vbap_cte.CODIGO_CLIENTE \n,vbak_vbap_cte.CODIGO_PRODUTO \n,vbak_vbap_cte.DATA_CRIACAO_OV \n,vbak_vbap_cte.ANO_PERIODO_OV \n,vbak_vbap_cte.NUMERO_PERIODO_OV \n,vbak_vbap_cte.ANO_NUMERO_PERIODO_OV \n,vbak_vbap_cte.NUMERO_OV \n,vbak_vbap_cte.NUMERO_ITEM_OV \n,vbak_vbap_cte.CATEGORIA_ITEM_OV \n,vbak_vbap_cte.CRIADO_POR_OV \n,vbak_vbap_cte.DATA_DOCUMENTO_OV \n,vbak_vbap_cte.CATEGORIA_DOCUMENTO_OV \n,vbak_vbap_cte.ORGANIZACAO_VENDAS_OV \n,vbak_vbap_cte.SETOR_ATIVIDADE_OV \n,vbak_vbap_cte.EQUIPE_VENDAS_OV \n,vbak_vbap_cte.ESCRITORIO_VENDAS_OV \n,vbak_vbap_cte.CODIGO_CONDICAO_DOCUMENTO_OV \n,vbak_vbap_cte.DATA_REMESSA_OV \n,vbak_vbap_cte.TIPO_PEDIDO_OV \n,vbak_vbap_cte.DATA_MODIFICACAO_OV \n,vbak_vbap_cte.CODIGO_PERIODO_VENDAS_OV\n,vbak_vbap_cte.CODIGO_EMPRESA_OV \n,vbak_vbap_cte.CODIGO_TIPO_DOCUMENTO_VENDAS \n,vbak_vbap_cte.CODIGO_CENTRO_OV_ITEM \n,vbak_vbap_cte.DESCRICAO_UNID_VENDA_OV_ITEM \n,vbak_vbap_cte.NUMERADOR_OV_ITEM \n,vbak_vbap_cte.DENOMINADOR_OV_ITEM \n,konv_cte.PK_KONV_CTE \n,konv_cte.CODIGO_CONDICAO\n,konv_cte.NUMERO_ITEM_CONDICAO\n,konv_cte.NUMERO_NIVEL_CONDICAO\n,konv_cte.CONTADOR_CONDICAO \n,konv_cte.DESCRICAO_TIPO_CONDICAO \n,konv_cte.VALOR_MONTANTE_CONDICAO \n,konv_cte.ESTATISTICA_CONDICAO \n,konv_cte.DATA_FIXA_PRECO_CONDICAO \n,sum(convert(numeric(18,2),konv_cte.VALOR_BASE_CONDICAO )) AS VALOR_BASE_CONDICAO\n,sum(convert(numeric(18,2),vbak_vbap_cte.QTDE_ITEM_OV )) AS QTDE_ITEM_OV\n,sum(convert(numeric(18,2),vbak_vbap_cte.VALOR_LIQUIDO_OV_ITEM )) As VALOR_LIQUIDO_OV_ITEM\n,sum(convert(numeric(18,2),konv_cte.VALOR_CONDICAO)) as VALOR_CONDICAO\ninto ODS.PRE_CARGA_SAP_FATO_ORDEM_VENDA\nfrom vbak_vbap_cte inner join konv_cte on \nvbak_vbap_cte.pk_vbak_vbap = konv_cte.pk_konv_cte\n\ngroup by vbak_vbap_cte.PK_VBAK_VBAP\n,vbak_vbap_cte.CODIGO_CLIENTE \n,vbak_vbap_cte.CODIGO_PRODUTO \n,vbak_vbap_cte.DATA_CRIACAO_OV \n,vbak_vbap_cte.ANO_PERIODO_OV \n,vbak_vbap_cte.NUMERO_PERIODO_OV \n,vbak_vbap_cte.ANO_NUMERO_PERIODO_OV \n,vbak_vbap_cte.NUMERO_OV \n,vbak_vbap_cte.NUMERO_ITEM_OV \n,vbak_vbap_cte.CATEGORIA_ITEM_OV \n,vbak_vbap_cte.CRIADO_POR_OV \n,vbak_vbap_cte.DATA_DOCUMENTO_OV \n,vbak_vbap_cte.CATEGORIA_DOCUMENTO_OV \n,vbak_vbap_cte.ORGANIZACAO_VENDAS_OV \n,vbak_vbap_cte.SETOR_ATIVIDADE_OV \n,vbak_vbap_cte.EQUIPE_VENDAS_OV \n,vbak_vbap_cte.ESCRITORIO_VENDAS_OV \n,vbak_vbap_cte.CODIGO_CONDICAO_DOCUMENTO_OV \n,vbak_vbap_cte.DATA_REMESSA_OV \n,vbak_vbap_cte.TIPO_PEDIDO_OV \n,vbak_vbap_cte.DATA_MODIFICACAO_OV \n,vbak_vbap_cte.CODIGO_PERIODO_VENDAS_OV\n,vbak_vbap_cte.CODIGO_EMPRESA_OV \n,vbak_vbap_cte.CODIGO_TIPO_DOCUMENTO_VENDAS \n,vbak_vbap_cte.CODIGO_CENTRO_OV_ITEM \n,vbak_vbap_cte.DESCRICAO_UNID_VENDA_OV_ITEM \n,vbak_vbap_cte.NUMERADOR_OV_ITEM \n,vbak_vbap_cte.DENOMINADOR_OV_ITEM \n,konv_cte.PK_KONV_CTE \n,konv_cte.CODIGO_CONDICAO\n,konv_cte.NUMERO_ITEM_CONDICAO\n,konv_cte.NUMERO_NIVEL_CONDICAO\n,konv_cte.CONTADOR_CONDICAO \n,konv_cte.DESCRICAO_TIPO_CONDICAO \n,konv_cte.VALOR_MONTANTE_CONDICAO \n,konv_cte.ESTATISTICA_CONDICAO \n,konv_cte.DATA_FIXA_PRECO_CONDICAO \n\n\n\nSELECT \nDIM_CLIENTE.SK_CLIENTE,\nDIM_PRODUTO.SK_PRODUTO,\nDIM_CALENDARIO.SK_DATA, \nODS.PK_VBAK_VBAP, \nODS.CODIGO_CLIENTE, \nODS.CODIGO_PRODUTO, \nODS.DATA_CRIACAO_OV, \nODS.ANO_PERIODO_OV, \nODS.NUMERO_PERIODO_OV, \nODS.ANO_NUMERO_PERIODO_OV, \nODS.NUMERO_OV, \nODS.NUMERO_ITEM_OV, \nODS.CATEGORIA_ITEM_OV, \nODS.CRIADO_POR_OV, \nODS.DATA_DOCUMENTO_OV, \nODS.CATEGORIA_DOCUMENTO_OV, \nODS.ORGANIZACAO_VENDAS_OV, \nODS.SETOR_ATIVIDADE_OV, \nODS.EQUIPE_VENDAS_OV, \nODS.ESCRITORIO_VENDAS_OV, \nODS.CODIGO_CONDICAO_DOCUMENTO_OV, \nODS.DATA_REMESSA_OV, \nODS.TIPO_PEDIDO_OV, \nODS.DATA_MODIFICACAO_OV, \nODS.CODIGO_PERIODO_VENDAS_OV, \nODS.CODIGO_EMPRESA_OV, \nODS.CODIGO_TIPO_DOCUMENTO_VENDAS, \nODS.CODIGO_CENTRO_OV_ITEM, \nODS.DESCRICAO_UNID_VENDA_OV_ITEM, \nODS.NUMERADOR_OV_ITEM, \nODS.DENOMINADOR_OV_ITEM, \nODS.PK_KONV_CTE,\nODS.CODIGO_CONDICAO, \nODS.NUMERO_ITEM_CONDICAO, \nODS.NUMERO_NIVEL_CONDICAO, \nODS.CONTADOR_CONDICAO, \nODS.DESCRICAO_TIPO_CONDICAO, \nODS.VALOR_MONTANTE_CONDICAO, \nODS.ESTATISTICA_CONDICAO, \nODS.DATA_FIXA_PRECO_CONDICAO, \nODS.VALOR_BASE_CONDICAO, \nODS.QTDE_ITEM_OV, \nODS.VALOR_LIQUIDO_OV_ITEM, \nODS.VALOR_CONDICAO \nFROM ODS.PRE_CARGA_SAP_FATO_ORDEM_VENDA AS ODS\nLEFT JOIN DW.SAP_DIM_CLIENTE AS DIM_CLIENTE  ON  ODS.CODIGO_CLIENTE = DIM_CLIENTE.CODIGO_CLIENTE\nLEFT JOIN DW.SAP_DIM_PRODUTO AS DIM_PRODUTO   ON ODS.CODIGO_PRODUTO = DIM_PRODUTO.CODIGO_PRODUTO \nLEFT JOIN DW.DIM_CALENDARIO  AS DIM_CALENDARIO ON ODS.DATA_CRIACAO_OV   = DIM_CALENDARIO.[DATA]",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"poolName": "Built-in",
				"databaseName": "master"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}