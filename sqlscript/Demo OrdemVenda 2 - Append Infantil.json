{
	"name": "Demo OrdemVenda 2 - Append Infantil",
	"properties": {
		"content": {
			"query": "SET ANSI_NULLS ON\nSET QUOTED_IDENTIFIER ON\n\n\nDECLARE @SEPARATOR VARCHAR(30) = '     //     '\nDECLARE @COUNT_BEFORE BIGINT\nSELECT COUNT_BEFORE = COUNT(*) FROM mm.ordem_venda\nPRINT @SEPARATOR + 'INÍCIO: ' + CAST(@COUNT_BEFORE AS VARCHAR(30)) + ' OVs'\n\n\nPRINT @SEPARATOR + 'Verifica se tmp_ordem_venda está vazia'\nIF EXISTS (SELECT TOP 1 1 FROM mm.tmp_ordem_venda)\nBEGIN\n\tselect 'ERRO: tmp_ordem_venda já possui registros.';\n\tThrow 50000, 'ERRO: tmp_ordem_venda já possui registros.', 1\n\tselect 1/0\nEND\n\n\nPRINT @SEPARATOR + 'Copy csv to tmp_ordem_venda'\nCOPY INTO mm.tmp_ordem_venda\n\t(pk_material 1, pk_OrdemVenda 2, pk_documento_condicao 3, pk_cliente 4, pk_representante 5, [OV - PV Comercial] 6, [OV - PV Número] 7, [%DataID] 8, [OV - Número] 9, [OV - Mês Despacho] 10, [OV - Ano Despacho] 11, [OV - Tipo Documento] 12, [OV - Grupo Tp.Documento] 13, [OV - Data Entrada] 14, [OV - Ano Entrada] 15, [OV - Mes Entrada] 16, [OV - Data Entrada (Dia)] 17, [OV - Programado] 18, [OV - Canal Venda] 19, [OV - Grupo Cliente] 20, [OV - Modalidade] 21, [OV - Entrada Ultimos 10] 22, [OV - Período PV/Ano] 23, [OV - Período PV] 24, [OV - Tipo Meta] 25, [OV - Periodo] 26, [OV - Sigla Nome Antigo] 27, [OV - Sigla Nome] 28, [OV - Regional] 29, [Meta - Regional] 30, [OV - Modo Envio] 31, [OV - Valor Desconto] 32, [OV - Item Grupo Tamanho] 33, [OV - Item Grupo Alvo] 34, [OV - Item Estação] 35, [OV - Item Estação Ano] 36, [OV - Item Coleção] 37, [OV - Item Qtde] 38, [OV - Item Qtde Geral] 39, [OV - Item Valor] 40, [OV - Item Valor Unit] 41, [OV - Item Status] 42, [OV - Item Equipe de Vendas] 43, [OV - Item Sigla Nome Ajs] 44, [OV - Tipo Pedido] 45, [OV - Item Mascara] 46, [OV - BU] 47, [OV Item - Marca Meta] 48, [Rec. Meta Total] 49, [OV - Item Motivo Recusa] 50, [Representante - Codigo Ajustado] 51, [OV - Valor Cancelado Antes PV] 52, [OV - Valor Cancelado Depois PV] 53, [OV - ColecaoAjustada] 54, [OV - Item Valor Geral] 55, [OV - Subcanal] 56, [OV - PV To Date] 57, [OV - Produto Grupo Temp] 58, [OV - Chave SSS Geral] 59, [Margem - PM] 60, [Margem - Custo PÇ] 61, [Margem - Perc. CustoV] 62, [OV - Margem Liq Produto] 63, [OV - SSS Geral] 64, [OV - SSS Ponderado] 65, [OV - Produto Grupo] 66, [OV - Abertura_AnoAtual] 67, [OV - Abertura_AnoAnterior] 68, [OV - Segmento] 69, [Meta - Quantidade] 70, [Meta - Valor] 71, [Meta - Grupo de Marca] 72, [Meta - Marca] 73, [Meta - Gerente Regional] 74, [Meta - Representante] 75, [Meta - Representante - Codigo Ajustado] 76, [Meta - Gerente de Área Fidelizado] 77, [Meta - Canal] 78, [Meta - ROB Meta (Venda)] 79, [Meta - ROB Meta] 80, [Meta - Qtde. Meta (Venda)] 81, [Meta - Qtde. Meta] 82, [Meta - ROL Meta Venda] 83, [Meta - ROL Meta] 84, [Meta - Margem Bruta Meta Venda] 85, [Meta - Margem Bruta Meta] 86, [Meta - Margem Liq. Meta Venda] 87, [Meta - Margem Liq. Meta] 88, [Meta - Qtde. Aberturas] 89, [Meta - Desconto Valor] 90, [Meta - Desconto Pct] 91, [RC - Qtde Prep] 92, [RC - Qtde RC_Prep] 93, [DiasVenda - Qtde] 94, [DiasVenda - Tipo] 95, [MetaTM - TM_Pct] 96)\nFROM 'https://sadevbrdatalakemalwee.dfs.core.windows.net/raw/brazil/demo/OrdemVendaInfantil.csv'\nWITH\n(\n\tFILE_TYPE = 'CSV'\n\t,MAXERRORS = 0\n\t,FIRSTROW = 2\n\t,ERRORFILE = 'https://sadevbrdatalakemalwee.dfs.core.windows.net/raw/brazil/demo/'\n\t,IDENTITY_INSERT = 'OFF'\n)\n\n\nPRINT @SEPARATOR + 'Delete ordem_venda Infantil'\nDELETE mm.ordem_venda where [Origem] = 'Infantil'\n\n\nPRINT @SEPARATOR + 'APPEND: insert tmp to ordem_venda'\ninsert into mm.ordem_venda\n \t(Origem, pk_material, pk_OrdemVenda, pk_documento_condicao, pk_cliente, pk_representante, [OV - PV Comercial], [OV - PV Número], [OV - Número], [OV - Mês Despacho], [OV - Ano Despacho], [OV - Tipo Documento], [OV - Grupo Tp.Documento], [OV - Data Entrada], [OV - Ano Entrada], [OV - Mes Entrada], [OV - Data Entrada (Dia)], [OV - Programado], [OV - Canal Venda], [OV - Grupo Cliente], [OV - Modalidade], [OV - Entrada Ultimos 10], [OV - Período PV/Ano], [OV - Período PV], [OV - Tipo Meta], [OV - Periodo], [OV - Sigla Nome Antigo], [OV - Sigla Nome], [OV - Regional], [Meta - Regional], [OV - Modo Envio], [OV - Valor Desconto], [OV - Item Grupo Tamanho], [OV - Item Grupo Alvo], [OV - Item Estação], [OV - Item Estação Ano], [OV - Item Coleção], [OV - Item Qtde], [OV - Item Qtde Geral], [OV - Item Valor], [OV - Item Valor Unit], [OV - Item Status], [OV - Item Equipe de Vendas], [OV - Item Sigla Nome Ajs], [OV - Tipo Pedido], [OV - Item Mascara], [OV - BU], [OV Item - Marca Meta], [Rec. Meta Total], [OV - Item Motivo Recusa], [Representante - Codigo Ajustado], [OV - Valor Cancelado Antes PV], [OV - Valor Cancelado Depois PV], [OV - ColecaoAjustada], [OV - Item Valor Geral], [OV - Subcanal], [OV - PV To Date], [OV - Produto Grupo Temp], [OV - Chave SSS Geral], [Margem - PM],  [Margem - Custo PÇ],  [Margem - Perc. CustoV], [OV - Margem Liq Produto], [OV - SSS Geral], [OV - SSS Ponderado], [OV - Produto Grupo], [OV - Abertura_AnoAtual], [OV - Abertura_AnoAnterior], [OV - Segmento], [Meta - Quantidade], [Meta - Valor], [Meta - Grupo de Marca], [Meta - Marca], [Meta - Gerente Regional], [Meta - Representante], [Meta - Representante - Codigo Ajustado], [Meta - Gerente de Área Fidelizado], [Meta - Canal], [Meta - ROB Meta (Venda)], [Meta - ROB Meta], [Meta - Qtde. Meta (Venda)], [Meta - Qtde. Meta], [Meta - ROL Meta Venda], [Meta - ROL Meta], [Meta - Margem Bruta Meta Venda], [Meta - Margem Bruta Meta], [Meta - Margem Liq. Meta Venda], [Meta - Margem Liq. Meta], [Meta - Qtde. Aberturas], [Meta - Desconto Valor], [Meta - Desconto Pct], [RC - Qtde Prep], [RC - Qtde RC_Prep], [DiasVenda - Qtde], [DiasVenda - Tipo], [MetaTM - TM_Pct])\nselect\n\t'Infantil' as Origem,\n\tpk_material, pk_OrdemVenda, pk_documento_condicao, pk_cliente, pk_representante, [OV - PV Comercial], [OV - PV Número], [OV - Número], [OV - Mês Despacho], [OV - Ano Despacho], [OV - Tipo Documento], [OV - Grupo Tp.Documento]\n,CONVERT(datetime, [OV - Data Entrada], 103) as [OV - Data Entrada],\n\t[OV - Ano Entrada], [OV - Mes Entrada], [OV - Data Entrada (Dia)], [OV - Programado], [OV - Canal Venda], [OV - Grupo Cliente], [OV - Modalidade], [OV - Entrada Ultimos 10], [OV - Período PV/Ano], [OV - Período PV], [OV - Tipo Meta], [OV - Periodo], [OV - Sigla Nome Antigo], [OV - Sigla Nome], [OV - Regional], [Meta - Regional], [OV - Modo Envio]\n,REPLACE([OV - Valor Desconto], ',', '.') as [OV - Valor Desconto]\n\t,[OV - Item Grupo Tamanho], [OV - Item Grupo Alvo], [OV - Item Estação], [OV - Item Estação Ano], [OV - Item Coleção], [OV - Item Qtde], [OV - Item Qtde Geral]\n,REPLACE([OV - Item Valor], ',', '.') as [OV - Item Valor]\n,REPLACE([OV - Item Valor Unit], ',', '.') as [OV - Item Valor Unit]\n\t,[OV - Item Status], [OV - Item Equipe de Vendas], [OV - Item Sigla Nome Ajs], [OV - Tipo Pedido], [OV - Item Mascara], [OV - BU], [OV Item - Marca Meta]\n,REPLACE([Rec. Meta Total], ',', '.') as [Rec. Meta Total]\n\t, [OV - Item Motivo Recusa], [Representante - Codigo Ajustado]\n,REPLACE([OV - Valor Cancelado Antes PV], ',', '.') as [OV - Valor Cancelado Antes PV]\n,REPLACE([OV - Valor Cancelado Depois PV], ',', '.') as [OV - Valor Cancelado Depois PV]\n\t, [OV - ColecaoAjustada]\n,REPLACE([OV - Item Valor Geral], ',', '.') as [OV - Item Valor Geral]\n\t,[OV - Subcanal], [OV - PV To Date], [OV - Produto Grupo Temp], [OV - Chave SSS Geral]\n,REPLACE([Margem - PM], ',', '.') as [Margem - PM]\n,NULLIF(REPLACE([Margem - Custo PÇ], ',', '.'), '---') as [Margem - Custo PÇ]\n,REPLACE([Margem - Perc. CustoV], ',', '.') as [Margem - Perc. CustoV]  --<<<<<<<<<<<<<<<<<<<< AUMENTAR casas precison/scale\n, CAST(CAST(REPLACE([OV - Margem Liq Produto], ',', '.') AS float) AS [decimal](19,4)) as [OV - Margem Liq Produto]  --<<<<<<<<<<<<<<<<<<<< AUMENTAR casas precison/scale \n\t,[OV - SSS Geral], [OV - SSS Ponderado], [OV - Produto Grupo], [OV - Abertura_AnoAtual], [OV - Abertura_AnoAnterior], [OV - Segmento], [Meta - Quantidade]\n,REPLACE([Meta - Valor], ',', '.') as [Meta - Valor]\n\t,[Meta - Grupo de Marca],[Meta - Marca],[Meta - Gerente Regional], [Meta - Representante], [Meta - Representante - Codigo Ajustado], [Meta - Gerente de Área Fidelizado], [Meta - Canal]\n,REPLACE([Meta - ROB Meta (Venda)], ',', '.') as [Meta - ROB Meta (Venda)]\n,REPLACE([Meta - ROB Meta], ',', '.') as [Meta - ROB Meta]\n\n,ROUND(REPLACE([Meta - Qtde. Meta (Venda)], ',', '.'), 0) as [Meta - Qtde. Meta (Venda)]   -- << #DIFERENTE DA ADULTO, VALORES DECIMAIS ARREDONDADOS#\n,ROUND(REPLACE([Meta - Qtde. Meta], ',', '.'), 0) as [Meta - Qtde. Meta]   -- << #DIFERENTE DA ADULTO, VALORES DECIMAIS ARREDONDADOS#\n\n,REPLACE([Meta - ROL Meta Venda], ',', '.') as [Meta - ROL Meta Venda]\n,REPLACE([Meta - ROL Meta], ',', '.') as [Meta - ROL Meta]\n,REPLACE([Meta - Margem Bruta Meta Venda], ',', '.') as [Meta - Margem Bruta Meta Venda]\n,REPLACE([Meta - Margem Bruta Meta], ',', '.') as [Meta - Margem Bruta Meta]\n,REPLACE([Meta - Margem Liq. Meta Venda], ',', '.') as [Meta - Margem Liq. Meta Venda]\n,REPLACE([Meta - Margem Liq. Meta], ',', '.') as [Meta - Margem Liq. Meta]\n\t,[Meta - Qtde. Aberturas]\n,REPLACE([Meta - Desconto Valor], ',', '.') as [Meta - Desconto Valor]   --<<<<<<<<<<<<<<<<<<<< AUMENTAR casas precison/scale e calcular\n,REPLACE(REPLACE([Meta - Desconto Pct], ',', '.'), '%', '') / 100.0 as [Meta - Desconto Pct]\n\t,[RC - Qtde Prep], [RC - Qtde RC_Prep], [DiasVenda - Qtde], [DiasVenda - Tipo]\n,REPLACE(REPLACE([MetaTM - TM_Pct], ',', '.'), '%', '') / 100.0 as [MetaTM - TM_Pct]\nfrom mm.tmp_ordem_venda\n\n\nPRINT @SEPARATOR + 'Drop tmp_ordem_venda'\nDROP TABLE mm.tmp_ordem_venda\n\n\n\nPRINT @SEPARATOR + 'Transformação dos campos calculados 1'\nUPDATE mm.ordem_venda SET\n\t[OV - Ano (PV Com.)] = RIGHT([OV - PV Comercial], 4)\n\t,[OV - Equipe de Vendas Ajustada] = CASE\n\t\tWHEN [OV - Item Equipe de Vendas] = 'Malwee Infantil' THEN 'Malwee Kids'\n\t\tELSE [OV - Item Equipe de Vendas]\n\tEND\n\n\nPRINT @SEPARATOR + 'Transformação dos campos calculados 2'\nUPDATE mm.ordem_venda SET\n\t[OV - BU Ajustada] = CASE\n\t\tWHEN [OV - Equipe de Vendas Ajustada] IN ('Malwee Adulto', 'Enfim') THEN 'Adulto'\n\t\tWHEN [OV - Equipe de Vendas Ajustada] IN ('Malwee Kids', 'Carinhoso', 'Zig Zig Zaa') THEN 'Infantil'\n\t\tELSE 'Sem Equipe'\n\tEND\n\t,[OV - Produto Grupo Ajustado] = CASE\n\t\tWHEN [OV - Equipe de Vendas Ajustada] IN ('Malwee Adulto', 'Malwee Kids')\n\t\t\tAND [OV - Produto Grupo] IN ('Básicos', 'Basicos', 'Moda', 'Jeans')\n\t\t\tTHEN [OV - Produto Grupo]\n\t\tELSE 'Outros Grupos'\n\tEND\n\n\nDECLARE @COUNT_AFTER BIGINT\nSELECT COUNT_AFTER = COUNT(*) FROM mm.ordem_venda\nSELECT 'IMPORTAÇÃO REALIZADA', GETDATE() AS DT_FINALIZADO, @COUNT_AFTER AS COUNT_AFTER, MAX([pk_OrdemVenda]) AS MAX_PK_OV, MAX([OV - Data Entrada]) AS ULTIMA_DATA_ENTRADA FROM mm.ordem_venda\nPRINT @SEPARATOR + 'FIM: ' + CAST(@COUNT_AFTER AS VARCHAR(30)) + ' OVs'\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"poolName": "dwmwe",
				"databaseName": "dwmwe"
			}
		},
		"type": "SqlQuery"
	}
}