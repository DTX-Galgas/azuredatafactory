{
	"name": "SQL script 1",
	"properties": {
		"content": {
			"query": "\n\ninsert into temp.cigam_gts_bi_clientes (ESTAB_IDCIGAM,CLIENTE_NOME,CLIENTE_CPFCNPJ,CLIENTE_EMAIL,CLIENTE_CIDADE,\nCLIENTE_ESTADO,CLIENTE_SEXO, CLIENTE_ANIVERSARIO,CLIENTE_DDD_CELULAR,CLIENTE_CELULAR,CLIENTE_ENDERECO,CLIENTE_NUMERO,\nCLIENTE_COMPLEMENTO, CLIENTE_BAIRRO,CLIENTE_CEP,NUM_MATRICULA,DAT_HORA_EXPORTACAO,FLAG_VIGENCIA,DAT_INICIO_VIGENCIA,\nDAT_FINAL_VIGENCIA)\nSELECT ESTAB_IDCIGAM,CLIENTE_NOME,CLIENTE_CPFCNPJ,CLIENTE_EMAIL,CLIENTE_CIDADE,CLIENTE_ESTADO,CLIENTE_SEXO, CLIENTE_ANIVERSARIO,\nCLIENTE_DDD_CELULAR,CLIENTE_CELULAR,CLIENTE_ENDERECO,CLIENTE_NUMERO,CLIENTE_COMPLEMENTO, CLIENTE_BAIRRO,CLIENTE_CEP,NUM_MATRICULA,\nDAT_HORA_EXPORTACAO,FLAG_VIGENCIA,DAT_INICIO_VIGENCIA,DAT_FINAL_VIGENCIA\nFROM (\nMERGE  temp.cigam_gts_bi_clientes   temp\nusing(\n    select top(100) ESTAB_IDCIGAM, \n    CLIENTE_CODIGO, \n    CLIENTE_NOME, \n    CLIENTE_CPFCNPJ, \n    CLIENTE_EMAIL, \n    CLIENTE_CIDADE, \n    CLIENTE_ESTADO, \n    CLIENTE_SEXO, \n    CLIENTE_ANIVERSARIO, \n    CLIENTE_DDD_CELULAR, \n    CLIENTE_CELULAR, \n    CLIENTE_ENDERECO, \n    CLIENTE_NUMERO, \n    CLIENTE_COMPLEMENTO, \n    CLIENTE_BAIRRO, \n    CLIENTE_CEP, \n    NUM_MATRICULA, \n    DAT_HORA_EXPORTACAO, \n    FLAG_VIGENCIA, \n    getdate()   DAT_INICIO_VIGENCIA, \n    null DAT_FINAL_VIGENCIA from [raw_data].[cigam_gst_bi_cliente]\n    where convert(date,DAT_HORA_EXPORTACAO) = '2021-02-22T00:00:00.0000000'\n) as raw on (temp.CLIENTE_CODIGO = raw.CLIENTE_CODIGO)\n                WHEN  NOT MATCHED BY TARGET then \n                insert (ESTAB_IDCIGAM,CLIENTE_CODIGO,CLIENTE_NOME,CLIENTE_CPFCNPJ,CLIENTE_EMAIL,CLIENTE_CIDADE,CLIENTE_ESTADO,CLIENTE_SEXO, \n                                        CLIENTE_ANIVERSARIO,CLIENTE_DDD_CELULAR,CLIENTE_CELULAR,CLIENTE_ENDERECO,CLIENTE_NUMERO,CLIENTE_COMPLEMENTO, \n                                        CLIENTE_BAIRRO,CLIENTE_CEP,NUM_MATRICULA,DAT_HORA_EXPORTACAO,FLAG_VIGENCIA,DAT_INICIO_VIGENCIA,DAT_FINAL_VIGENCIA)\n                                values (\n                                        raw.ESTAB_IDCIGAM,raw.CLIENTE_CODIGO,raw.CLIENTE_NOME,raw.CLIENTE_CPFCNPJ,raw.CLIENTE_EMAIL,raw.CLIENTE_CIDADE,raw.CLIENTE_ESTADO,raw.CLIENTE_SEXO, \n                                        raw.CLIENTE_ANIVERSARIO,raw.CLIENTE_DDD_CELULAR,raw.CLIENTE_CELULAR,raw.CLIENTE_ENDERECO,raw.CLIENTE_NUMERO,raw.CLIENTE_COMPLEMENTO, \n                                        raw.CLIENTE_BAIRRO,raw.CLIENTE_CEP,raw.NUM_MATRICULA,raw.DAT_HORA_EXPORTACAO,raw.FLAG_VIGENCIA,raw.DAT_INICIO_VIGENCIA,raw.DAT_FINAL_VIGENCIA\n                                ) \n                WHEN MATCHED AND  (raw.cliente_codigo != temp.cliente_codigo) and temp.DAT_FINAL_VIGENCIA is null \n                then update set temp.DAT_FINAL_VIGENCIA    = getdate(), temp.flag_vigencia = 0\n                OUTPUT $ACTION ACTION_TAKEN,\n                raw.ESTAB_IDCIGAM,\n                raw.CLIENTE_NOME,\n                raw.CLIENTE_CPFCNPJ,\n                raw.CLIENTE_EMAIL,\n                raw.CLIENTE_CIDADE,\n                raw.CLIENTE_ESTADO,\n                raw.CLIENTE_SEXO, \n                raw.CLIENTE_ANIVERSARIO,\n                raw.CLIENTE_DDD_CELULAR,\n                raw.CLIENTE_CELULAR,\n                raw.CLIENTE_ENDERECO,\n                raw.CLIENTE_NUMERO,\n                raw.CLIENTE_COMPLEMENTO, \n                raw.CLIENTE_BAIRRO,\n                raw.CLIENTE_CEP,\n                raw.NUM_MATRICULA,\n                raw.DAT_HORA_EXPORTACAO,\n                raw.FLAG_VIGENCIA,\n                raw.DAT_INICIO_VIGENCIA,\n                raw.DAT_FINAL_VIGENCIA\n) AS MERGE_OUT\nWHERE  MERGE_OUT.ACTION_TAKEN = 'UPDATE';\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"poolName": "dwmwe",
				"databaseName": "dwmwe"
			}
		},
		"type": "SqlQuery"
	}
}